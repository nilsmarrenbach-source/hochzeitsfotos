<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hochzeit The Marrenbach's</title>

  <!-- Schriften -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#f8f6f4;
      --fg:#1a1a1a;
      --muted:#6a6a6a;
      --accent:#b74a3a; /* Rostrot */
      --accent-dark:#9d3f31;
      --mine:#fff2ef;    /* eigene Nachricht */
      --other:#ffffff;   /* fremde Nachricht */
      --border:#f0e4e1;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--fg);
      text-align:center;
    }

    /* Header */
    header {
      background:linear-gradient(180deg, var(--accent), var(--accent-dark));
      color:#fff;
      padding:28px 16px 22px;
      position:relative;
      overflow:hidden;
    }
    header h1 {
      margin:0;
      font-weight:400;
      font-size:36px;
      font-family:"Great Vibes", cursive;
    }

    /* Login Overlay (globaler Benutzername) */
    #userLoginOverlay {
      position:fixed; inset:0; background:var(--bg);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:9999;
      padding:20px;
    }
    #userLoginOverlay h2 { font-family:"Playfair Display", serif; color:var(--accent); margin:0 0 10px; }
    #userLoginOverlay p { color:var(--muted); margin:0 0 14px; }
    #userLoginOverlay input {
      max-width:320px; width:90%;
      margin:10px 0; padding:12px; font-size:1rem;
      border:1px solid var(--border); border-radius:10px;
    }
    #userLoginOverlay button {
      padding:10px 18px; border-radius:10px; background:var(--accent); color:#fff;
      border:1px solid var(--accent-dark); cursor:pointer; font-weight:600;
    }

    /* Navigation */
    nav {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:16px;
    }
    nav button {
      appearance:none; border:1px solid #e8d9d5; background:#fff; color:var(--accent);
      padding:10px 16px; border-radius:999px; cursor:pointer; font-weight:600;
      box-shadow:0 4px 14px rgba(183,74,58,.08);
    }
    nav button:hover { border-color:#e1c8c2; transform:translateY(-1px); }
    nav button[aria-current="page"] {
      background:var(--accent); color:#fff; border-color:var(--accent);
      box-shadow:0 6px 18px rgba(183,74,58,.25);
    }

    /* Layout */
    main { max-width:1000px; margin:0 auto; padding:10px 16px 40px; }
    .section {
      display:none; text-align:left; background:#fff; padding:22px; border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06); margin-top:8px;
      border:1px solid var(--border);
    }
    .section.active { display:block; }
    h2 {
      margin-top:0; text-align:center; font-family:"Playfair Display", serif; font-weight:600;
      color:var(--accent);
    }
    h3 { font-family:"Playfair Display", serif; }

    a.btn, .btn {
      display:inline-block; background:var(--accent); color:#fff; text-decoration:none;
      padding:10px 16px; border-radius:10px; margin:6px 6px 0; border:1px solid var(--accent-dark);
      box-shadow:0 6px 16px rgba(183,74,58,.25); cursor:pointer;
    }
    a.btn:hover, .btn:hover { filter:brightness(0.98); transform:translateY(-1px); }
    .grid2 { display:grid; grid-template-columns:1fr; gap:18px; }
    @media (min-width:700px){ .grid2 { grid-template-columns:1fr 1fr; } }
    iframe { width:100%; height:70vh; border:none; background:#f1f1f1; border-radius:12px; }

    .muted { color:var(--muted); font-size:.95rem; }
    .note { color:#9a8f8d; font-size:.9rem; text-align:center; }

    /* Startbild */
    img.hero { max-width:100%; border-radius:20px; box-shadow:0 10px 28px rgba(0,0,0,.15); }

    /* Quiz */
    .question { padding:16px 16px; border:1px solid var(--border); border-radius:12px; background:#fffdfc; }
    .answers label { display:block; margin:8px 0; padding:8px 10px; border:1px solid #f2e7e4; border-radius:10px; cursor:pointer; }
    .answers input { margin-right:8px; }
    #quiz-progress { font-family:"Playfair Display", serif; color:var(--muted); }
    ul#scoreboard { list-style:none; padding:0; margin:0; }
    ul#scoreboard li {
      padding:8px 10px; border-bottom:1px dashed #e5e5e5; display:flex; justify-content:space-between;
      font-family:"Playfair Display", serif;
    }

    /* Chat */
    #chatHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    #messages { height:340px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:12px; background:#fffbfa; }
    .msg-wrap { display:flex; margin:6px 0; }
    .msg {
      padding:8px 10px; border-radius:10px; max-width:70%; word-wrap:break-word;
      border:1px solid #f2e7e4; background:var(--other); text-align:left;
    }
    .msg .meta { font-size:.8rem; color:#777; margin-bottom:4px; display:flex; align-items:center; gap:6px; }
    .msg .del { display:inline-block; margin-left:6px; background:none; border:1px solid #e1c8c2; border-radius:6px; padding:2px 6px; cursor:pointer; }
    .mine-wrap { justify-content:flex-end; }
    .mine { background:var(--mine); border-color:#f0d3cc; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"], textarea {
      width:100%; padding:10px 12px; border:1px solid #e9dcd8; border-radius:10px; font:inherit; background:#fffdfc;
    }

    /* PDF Zoom Toolbar */
    .pdfToolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 0}
    .pdfToolbar .btn{padding:6px 10px}
    .pdfViewport{position:relative;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#f1f1f1;height:70vh}
    .pdfViewport iframe{width:100%;height:100%;border:0;transform-origin:top left}

    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .stats{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:800px){.stats{grid-template-columns:1fr 1fr}}
    canvas{width:100%;height:220px;border:1px solid var(--border);border-radius:10px;background:#fff}
  </style>
</head>
<body>
  <!-- Globaler Benutzername als Pflicht -->
  <div id="userLoginOverlay">
    <h2>Bitte gib deinen Namen ein</h2>
    <p>Dieser Name wird f√ºr Chat, Quiz, ‚Äû√úber uns‚Äú und Musikw√ºnsche verwendet.</p>
    <input type="text" id="globalName" placeholder="Dein Name" />
    <button id="saveGlobalName">Weiter</button>
  </div>

  <header>
    <h1>Willkommen zur Hochzeit The Marrenbach's</h1>
  </header>

  <nav aria-label="Hauptnavigation">
    <button data-target="start" aria-current="page">üè† Startseite</button>
    <button data-target="fotos">üì∏ Fotos</button>
    <button data-target="speisekarte">üçΩÔ∏è Speisekarte</button>
    <button data-target="quiz">‚ùì Quiz</button>
    <button data-target="chat">üí¨ Chat</button>
    <button data-target="music">üéµ Musikwunsch</button>
    <button data-target="gaesteantworten">üìù √úber uns</button>
    <button data-target="admin">üõ†Ô∏è Admin</button>
  </nav>

  <main>
    <!-- Startseite -->
    <section id="start" class="section active">
      <h2>‚ù§Ô∏è Willkommen</h2>
      <p class="muted" style="text-align:center">Sch√∂n, dass ihr da seid ‚Äì feiert mit uns diesen besonderen Tag!</p>
      <div style="text-align:center; margin-top:20px;">
        <img src="start.jpg" alt="Brautpaar" class="hero" />
      </div>
    </section>

    <!-- Fotos -->
    <section id="fotos" class="section">
      <h2>üì∑ Fotos hochladen oder ansehen</h2>
      <p class="muted" style="text-align:center">W√§hlt eine Option:</p>
      <div class="grid2" style="text-align:center">
        <div>
          <h3>Hochladen</h3>
          <p>Teilt eure sch√∂nsten Momente mit uns!</p>
          <a class="btn" target="_blank" href="https://www.dropbox.com/request/yq0IJGtF4kC2J1Cfqyg3">üì• Fotos hochladen</a>
        </div>
        <div>
          <h3>Ansehen & Herunterladen</h3>
          <p>Alle Bilder der G√§ste an einem Ort.</p>
          <a class="btn" target="_blank" href="https://www.dropbox.com/scl/fo/2avn44dduw9frc86a2vuc/ADTyW_6937n1flsezIGobfQ?rlkey=p427wm8zvsrqo64yyg8yex0r6&st=navv0buq&dl=0">üì§ Fotos ansehen</a>
        </div>
      </div>
    </section>

    <!-- Speisekarte -->
    <section id="speisekarte" class="section">
      <h2>üçΩÔ∏è Speisekarte</h2>
      <div class="pdfToolbar">
        <button class="btn" onclick="zoomPDF('menuFrame','out')">‚àí</button>
        <button class="btn" onclick="zoomPDF('menuFrame','reset')">100%</button>
        <button class="btn" onclick="zoomPDF('menuFrame','in')">+</button>
        <a class="btn" href="speisekarte.pdf" target="_blank">üîé Vollbild</a>
      </div>
      <div class="pdfViewport">
        <iframe id="menuFrame" src="speisekarte.pdf" title="Speisekarte"></iframe>
      </div>
      <div id="menuFallback" class="note" style="display:none;">Speisekarte nicht gefunden (speisekarte.pdf).</div>
    </section>

    <!-- Quiz (Einzelfragen) -->
    <section id="quiz" class="section">
      <h2>‚ùì Hochzeitsquiz</h2>
      <div id="quiz-login">
        <p>Dein Benutzername (oben) wird verwendet.</p>
        <button class="btn" id="quizStart">Quiz starten</button>
      </div>
      <div id="quiz-run" style="display:none">
        <div style="text-align:center; margin-bottom:8px;" class="muted">
          <span id="quiz-progress">Frage 1/10</span>
        </div>
        <div id="quiz-question" class="question"></div>
        <div id="quiz-answers" class="answers" style="margin-top:8px;"></div>
        <div style="text-align:center; margin-top:14px;">
          <button class="btn" id="quizNext" disabled>Weiter</button>
        </div>
      </div>
      <div id="result" style="display:none; text-align:center; font-weight:600; margin-top:14px"></div>
      <div class="scoreboard" style="margin-top:18px;">
        <h3 style="text-align:center">üèÜ Rangliste</h3>
        <ul id="scoreboard"></ul>
      </div>
    </section>

    <!-- Chat -->
    <section id="chat" class="section">
      <h2>üí¨ Hochzeitschat</h2>
      <div id="chatHeader">
        <div class="muted" id="chatStatus"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="muted" id="chatUserBadge"></div>
          <button class="btn" id="adminLogin" style="padding:6px 10px;">Admin</button>
        </div>
      </div>

      <div id="chatBox">
        <div id="messages"></div>
        <div class="row" style="margin-top:10px;">
          <input type="text" id="messageInput" placeholder="Deine Nachricht" />
          <button class="btn" id="chatSend">Senden</button>
        </div>
      </div>
    </section>

    <!-- Musikwunsch -->
    <section id="music" class="section">
      <h2>üéµ Musikwunsch</h2>
      <p class="muted" style="text-align:center">Jeder darf <strong>maximal einen Wunsch pro Stunde</strong> abgeben.</p>
      <div class="grid2">
        <div class="card">
          <div class="row">
            <input type="text" id="songTitle" placeholder="Songtitel" />
          </div>
          <div class="row" style="margin-top:8px;">
            <input type="text" id="songArtist" placeholder="K√ºnstler" />
          </div>
          <div class="row" style="margin-top:8px;">
            <input type="text" id="songNote" placeholder="Widmung/Kommentar (optional)" />
          </div>
          <div style="text-align:center; margin-top:10px;">
            <button class="btn" id="songSend">Wunsch senden</button>
            <div id="songHint" class="muted" style="margin-top:6px;"></div>
          </div>
        </div>
        <div class="card">
          <h3 style="text-align:center;margin:0 0 8px;">Letzte W√ºnsche</h3>
          <div id="songList"></div>
        </div>
      </div>
    </section>

    <!-- √úber uns -->
    <section id="gaesteantworten" class="section">
      <h2>üìù √úber uns</h2>
      <p class="muted">Schreib eine kurze Zeile ‚Äì was macht <strong>Lea</strong> und was macht <strong>Nils</strong> aus?</p>
      <div class="grid2">
        <div>
          <h3>Zu Lea</h3>
          <textarea id="aboutLea" rows="4" placeholder="Dein Satz zu Lea..."></textarea>
        </div>
        <div>
          <h3>Zu Nils</h3>
          <textarea id="aboutNils" rows="4" placeholder="Dein Satz zu Nils..."></textarea>
        </div>
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="btn" id="aboutSend">Absenden</button>
      </div>
      <div style="margin-top:16px;">
        <h3 style="text-align:center">Eure Antworten (live)</h3>
        <div id="aboutList" class="grid2"></div>
      </div>
    </section>

    <!-- Admin (nur sichtbar nach erfolgreichem Login) -->
    <section id="admin" class="section" style="display:none;">
      <h2>üõ†Ô∏è Admin-Dashboard</h2>
      <p class="muted" id="adminState">Nicht im Adminmodus. Klicke irgendwo auf ‚ÄûAdmin‚Äú und gib den Code ein.</p>

      <div class="stats" id="adminStatsArea" style="display:none;">
        <div class="card">
          <h3 style="margin-top:0;">Nutzer & Aktivit√§t</h3>
          <div id="statsUsers" class="muted">‚Äì</div>
          <div id="statsEvents" class="muted">‚Äì</div>
        </div>
        <div class="card">
          <h3 style="margin-top:0;">Nutzung nach Stunde (heute)</h3>
          <canvas id="chartUsage"></canvas>
        </div>
      </div>

      <div class="card" id="quizAdminWrap" style="margin-top:12px; display:none;">
        <h3 style="margin-top:0;">Quiz verwalten</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
          <button class="btn" id="btnClearQuiz">Gesamtes Quiz leeren</button>
        </div>
        <div id="adminScoreList" class="muted"></div>
      </div>

      <div class="card" id="adminEventsWrap" style="margin-top:12px; display:none;">
        <h3 style="margin-top:0;">Letzte Aktionen</h3>
        <div id="eventsList"></div>
      </div>
    </section>
  </main>

  <!-- PDF-Zoom -->
  <script>
    const __pdfScale = {};
    function zoomPDF(frameId, action){
      const frame = document.getElementById(frameId);
      if(!frame) return;
      const cur = __pdfScale[frameId] ?? 1;
      let s = cur;
      if(action==='in')  s = Math.min(3,  (cur + 0.2));
      if(action==='out') s = Math.max(0.5,(cur - 0.2));
      if(action==='reset') s = 1;
      __pdfScale[frameId] = s;
      frame.style.transform = `scale(${s})`;
      frame.style.width = `${100/s}%`;
      frame.style.height = '100%';
    }
  </script>

  <!-- Navigation + PDF-Fallbacks -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const navButtons = document.querySelectorAll('nav button');
      function activate(id, btn) {
        if (id === 'admin' && !window.__isAdmin) {
          const tryLogin = confirm('Admin-Bereich ‚Äì Code eingeben?');
          if (tryLogin) window.__promptAdmin && window.__promptAdmin(true);
          return;
        }
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        navButtons.forEach(b => b.removeAttribute('aria-current'));
        if (btn) btn.setAttribute('aria-current','page');
      }
      navButtons.forEach(btn => { btn.addEventListener('click', () => activate(btn.dataset.target, btn)); });

      const mf = document.getElementById('menuFrame');
      setTimeout(() => {
        if (mf && mf.contentDocument === null) document.getElementById('menuFallback').style.display='block';
      }, 1200);
    });
  </script>

  <!-- App-Logik & Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onChildRemoved, remove,
      get, set, update, onChildChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* Firebase-Konfiguration */
    const firebaseConfig = {
      apiKey: "AIzaSyDEYeCmTkVGf4pTLCS-s3fV9jo1ivVPMj8",
      authDomain: "hochzeitschat.firebaseapp.com",
      databaseURL: "https://hochzeitschat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hochzeitschat",
      storageBucket: "hochzeitschat.appspot.com",
      messagingSenderId: "180005609648",
      appId: "1:180005609648:web:f8c8cd278a1e3830501b75"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ===== Globaler Benutzername via Overlay ===== */
    const ADMIN_CODE = "Marrenbach24!";
    window.__isAdmin = false;
    let GLOBAL_USER = "";

    const overlay = document.getElementById('userLoginOverlay');
    const nameInput = document.getElementById('globalName');
    const saveBtn   = document.getElementById('saveGlobalName');

    function setUserInDB(name){
      update(ref(db, 'users/' + encodeURIComponent(name)), { lastSeen: Date.now(), createdAt: Date.now() }).catch(()=>{});
    }
    function logEvent(action, extra = {}){
      const u = GLOBAL_USER || 'Gast';
      push(ref(db, 'events'), { user: u, action, ts: Date.now(), ...extra });
    }
    function initAppWithUser(){
      const badge = document.getElementById('chatUserBadge');
      const status= document.getElementById('chatStatus');
      if (badge) badge.textContent = `üîí Eingeloggt als: ${GLOBAL_USER}`;
      if (status) status.textContent = "Verbunden";
      setUserInDB(GLOBAL_USER);
      logEvent('visit');
    }

    const saved = (localStorage.getItem('globalName')||"").trim();
    if (saved) {
      GLOBAL_USER = saved;
      overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
      initAppWithUser();
    } else {
      document.body.style.overflow = 'hidden';
    }
    saveBtn.addEventListener('click', () => {
      const n = (nameInput.value||"").trim();
      if(!n) return alert("Bitte gib einen Namen ein.");
      GLOBAL_USER = n;
      localStorage.setItem('globalName', GLOBAL_USER);
      overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
      initAppWithUser();
    });

    /* ===== Admin-Login ===== */
    const adminLoginBtn = document.getElementById('adminLogin');
    const adminSection  = document.getElementById('admin');
    const adminState    = document.getElementById('adminState');
    const adminStatsArea= document.getElementById('adminStatsArea');
    const adminEventsWrap = document.getElementById('adminEventsWrap');
    const quizAdminWrap = document.getElementById('quizAdminWrap');

    function enableAdminUI(){
      window.__isAdmin = true;
      if (adminSection) adminSection.style.display = 'block';
      if (adminStatsArea) adminStatsArea.style.display = 'grid';
      if (adminEventsWrap) adminEventsWrap.style.display = 'block';
      if (quizAdminWrap) quizAdminWrap.style.display = 'block';
      if (adminState) adminState.textContent = "Adminmodus aktiv.";
      refreshAdminUI();
      renderAdminScoreList(); // beim Betreten direkt f√ºllen
    }
    function promptAdmin(showSectionAfter = false){
      const code = prompt("Admin-Code eingeben:");
      if (code === ADMIN_CODE) {
        alert("Admin-Modus aktiv.");
        enableAdminUI();
        if (showSectionAfter) {
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          adminSection.classList.add('active');
          document.querySelectorAll('nav button').forEach(b=>b.removeAttribute('aria-current'));
          document.querySelector('nav button[data-target="admin"]')?.setAttribute('aria-current','page');
        }
      } else if (code !== null) {
        alert("Falscher Code.");
      }
    }
    window.__promptAdmin = promptAdmin;
    adminLoginBtn?.addEventListener('click', () => promptAdmin(false));

    function refreshAdminUI() {
      document.querySelectorAll('.msg .del, .question .del, #songList .del').forEach(btn => {
        btn.style.display = window.__isAdmin ? 'inline-block' : 'none';
      });
    }

    /* ===== Navigation-Events f√ºr Stats ===== */
    document.querySelectorAll('nav button').forEach(b=>{
      b.addEventListener('click', ()=> logEvent('nav', { to: b.dataset.target }));
    });

    /* ===== QUIZ ===== */
    const questions = [
      { q:'Welches Haushaltsger√§t wird von Lea t√§glich genutzt und treibt Nils in den Wahnsinn?', a:['Trockner','Staubsauger','Wasserkocher'], correct:'Staubsauger' },
      { q:'Wann sind Lea und Nils zusammengekommen?', a:['08.03.2017','18.03.2018','28.03.2017'], correct:'28.03.2017' },
      { q:'Wer von deren Freunden war beim ersten Date anwesend?', a:['Theresa','Lea-Stutzinger','Markus'], correct:'Theresa' },
      { q:'Welche Handgeste hat Lea ihrem Schwiegervater beim ersten Kennenlernen zur Begr√º√üung gezeigt?', a:['Peacezeichen','Gewinkt','High 5'], correct:'Peacezeichen' },
      { q:'Was war Nils schlimmstes Verbrechen bei seinen Schwiegereltern?', a:['nichtabgesp√ºlt nach langer Toilettensitzung','aus dem Dachfenster √ºbergeben','Ollis Schraubschl√ºssel geliehen und nie wiedergegeben'], correct:'aus dem Dachfenster √ºbergeben' },
      { q:'Welche Krankheit schreibt Lea Nils zu?', a:['Autismus','Achs','Zwangsst√∂rung'], correct:'Autismus' },
      { q:'Zu was wird Lea wenn sie schlecht gelaunt ist?', a:['dem unglaublichen Hulk','Giftzwerg','Fruchtzwerg'], correct:'Giftzwerg' },
      { q:'Wie lautet Nils legend√§rer durch seine Mutter vergebener Spitzname?', a:['b√ºbchen','mamab√§rchen','p√ºppelmann'], correct:'p√ºppelmann' },
      { q:'Was ist Nils und Leas Einrichtungssteal?', a:['Antik','modern','Eklektizismus'], correct:'Eklektizismus' },
      { q:'Wer hat zuhause die Hosen an?', a:['Lea','Nils','Beide'], correct:'Beide' },
    ];

    const quizStartBtn = document.getElementById('quizStart');
    const quizLogin    = document.getElementById('quiz-login');
    const quizRun      = document.getElementById('quiz-run');
    const quizQ        = document.getElementById('quiz-question');
    const quizA        = document.getElementById('quiz-answers');
    const quizNextBtn  = document.getElementById('quizNext');
    const quizProgress = document.getElementById('quiz-progress');
    const resultEl     = document.getElementById('result');
    const scoreboardEl = document.getElementById('scoreboard');

    let currentIndex = 0;

    // Zentrales Score-Array (mit Keys) f√ºr Rangliste & Admin
    const scores = []; // Elemente: { key, name, score, total, ts }

    function renderPublicScoreboard() {
      const sorted = [...scores].sort((a,b) => b.score - a.score || a.ts - b.ts);
      scoreboardEl.innerHTML = sorted
        .map((s,i)=>`<li><span>${i+1}. ${s.name}</span><strong>${s.score}/${s.total}</strong></li>`)
        .join('');
    }

    function renderAdminScoreList() {
      const listEl = document.getElementById('adminScoreList');
      if (!listEl) return;
      if (!window.__isAdmin) { listEl.innerHTML = ''; return; }
      if (scores.length === 0) { listEl.innerHTML = 'Keine Eintr√§ge.'; return; }

      const sorted = [...scores].sort((a,b) => b.ts - a.ts);
      listEl.innerHTML = sorted.map(s => {
        const when = new Date(s.ts).toLocaleString();
        return `
          <div class="question" data-score-id="${s.key}" style="margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>${s.name}</strong> ‚Äì ${s.score}/${s.total} <span class="muted">(${when})</span></div>
              <div>
                <button class="del btnScoreDelete">L√∂schen</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Buttons verdrahten
      listEl.querySelectorAll('.btnScoreDelete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (!window.__isAdmin) return;
          const wrap = e.target.closest('[data-score-id]');
          const scoreId = wrap?.dataset?.scoreId;
          if (!scoreId) return;
          if (confirm('Diesen Quiz-Eintrag l√∂schen?')) {
            remove(ref(db, 'scores/' + scoreId));
          }
        });
      });
    }

    // Admin-Gesamtl√∂schung
    const btnClearQuiz = document.getElementById('btnClearQuiz');
    btnClearQuiz?.addEventListener('click', async () => {
      if (!window.__isAdmin) return;
      if (!confirm('Wirklich ALLE Quiz-Eintr√§ge l√∂schen?')) return;
      await remove(ref(db, 'scores'));
      // lokal leeren
      scores.splice(0, scores.length);
      renderPublicScoreboard();
      renderAdminScoreList();
      alert('Alle Quiz-Eintr√§ge wurden gel√∂scht.');
    });

    function renderQuestion() {
      const q = questions[currentIndex];
      quizProgress.textContent = `Frage ${currentIndex + 1}/${questions.length}`;
      quizQ.innerHTML = `<p><strong>${currentIndex + 1}.</strong> ${q.q}</p>`;
      const name = 'q';
      quizA.innerHTML = q.a.map(ans => `<label><input type="radio" name="${name}" value="${ans}"> ${ans}</label>`).join("");
      quizNextBtn.disabled = true;
      quizA.querySelectorAll(`input[name="${name}"]`).forEach(r => {
        r.addEventListener('change', () => {
          quizNextBtn.disabled = false;
        });
      });
      quizNextBtn.textContent = (currentIndex === questions.length - 1) ? "Abschicken" : "Weiter";
    }

    function startQuiz() {
      if(!GLOBAL_USER){ alert("Bitte zuerst deinen Namen eingeben."); return; }
      currentIndex = 0;
      quizLogin.style.display = 'none';
      quizRun.style.display   = 'block';
      resultEl.style.display  = 'none';
      renderQuestion();
      logEvent('quiz_start');
    }
    quizStartBtn.addEventListener('click', startQuiz);

    let givenAnswers = Array(questions.length).fill(null);
    quizNextBtn.addEventListener('click', () => {
      const sel = quizA.querySelector('input[type="radio"]:checked');
      if (!sel) return;
      givenAnswers[currentIndex] = sel.value;

      if (currentIndex === questions.length - 1) {
        let score = 0;
        questions.forEach((q, i) => { if (givenAnswers[i] === q.correct) score++; });

        push(ref(db, 'scores'), { name: GLOBAL_USER, score, total: questions.length, ts: Date.now() });
        quizRun.style.display  = 'none';
        resultEl.style.display = 'block';
        resultEl.textContent   = `${GLOBAL_USER}, du hast ${score} von ${questions.length} Punkten erreicht!`;
        logEvent('quiz_finish', { score });
        // Reset f√ºr erneutes Spielen (falls Admin sp√§ter l√∂scht)
        givenAnswers = Array(questions.length).fill(null);
        return;
      }
      currentIndex++;
      renderQuestion();
    });

    // Scores: live hinzuf√ºgen / √§ndern / entfernen
    onChildAdded(ref(db, 'scores'), (snap) => {
      const v = snap.val();
      const obj = { key: snap.key, name: v.name, score: v.score, total: v.total, ts: v.ts };
      // ersetzen, falls Doppel
      const idx = scores.findIndex(s => s.key === obj.key);
      if (idx >= 0) scores[idx] = obj; else scores.push(obj);
      renderPublicScoreboard();
      if (window.__isAdmin) renderAdminScoreList();
    });

    onChildChanged(ref(db, 'scores'), (snap) => {
      const v = snap.val();
      const obj = { key: snap.key, name: v.name, score: v.score, total: v.total, ts: v.ts };
      const idx = scores.findIndex(s => s.key === obj.key);
      if (idx >= 0) scores[idx] = obj;
      renderPublicScoreboard();
      if (window.__isAdmin) renderAdminScoreList();
    });

    onChildRemoved(ref(db, 'scores'), (snap) => {
      const k = snap.key;
      const idx = scores.findIndex(s => s.key === k);
      if (idx >= 0) scores.splice(idx, 1);
      renderPublicScoreboard();
      if (window.__isAdmin) renderAdminScoreList();
    });

    /* ===== CHAT mit Admin-L√∂schen ===== */
    const chatSendBtn = document.getElementById('chatSend');
    const messagesEl  = document.getElementById('messages');
    const chatStatus  = document.getElementById('chatStatus');
    const chatUserBadge = document.getElementById('chatUserBadge');

    function sendMessage(){
      if(!GLOBAL_USER){ alert("Bitte zuerst deinen Namen eingeben."); return; }
      const inp = document.getElementById('messageInput');
      const msg = (inp?.value || "").trim();
      if (!msg) return;
      push(ref(db, 'messages'), { name: GLOBAL_USER, message: msg, ts: Date.now() });
      inp.value = "";
      logEvent('chat_send');
    }
    chatSendBtn.addEventListener('click', sendMessage);

    function displayTime(ts){ return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    onChildAdded(ref(db, 'messages'), (snap) => {
      const id = snap.key;
      const m  = snap.val();
      const mine = (GLOBAL_USER && m.name === GLOBAL_USER);

      const wrap = document.createElement('div');
      wrap.className = mine ? 'msg-wrap mine-wrap' : 'msg-wrap';
      wrap.dataset.id = id;

      const bubble = document.createElement('div');
      bubble.className = mine ? 'msg mine' : 'msg';
      const time = displayTime(m.ts);

      const del = document.createElement('button');
      del.className = 'del';
      del.textContent = '‚úï';
      del.style.display = window.__isAdmin ? 'inline-block' : 'none';
      del.addEventListener('click', () => {
        if (!window.__isAdmin) return;
        if (confirm("Diese Nachricht wirklich l√∂schen?")) {
          remove(ref(db, 'messages/' + id));
        }
      });

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `[${time}] <strong>${m.name}</strong>`;
      meta.appendChild(del);

      const txt = document.createElement('div');
      txt.textContent = m.message;

      bubble.appendChild(meta);
      bubble.appendChild(txt);
      wrap.appendChild(bubble);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (chatUserBadge && GLOBAL_USER) chatUserBadge.textContent = `üîí Eingeloggt als: ${GLOBAL_USER}`;
      if (chatStatus) chatStatus.textContent = "Verbunden";
    });

    onChildRemoved(ref(db, 'messages'), (snap) => {
      const id = snap.key;
      const el = document.querySelector(`.msg-wrap[data-id="${id}"]`);
      if (el) el.remove();
    });

    /* ===== √úBER UNS ‚Äì Eintr√§ge + Admin-L√∂schen + Admin-Bearbeiten ===== */
    const aboutSendBtn = document.getElementById('aboutSend');
    const aboutList    = document.getElementById('aboutList');

    function submitAbout(){
      if(!GLOBAL_USER){ alert("Bitte zuerst deinen Namen eingeben."); return; }
      const lea  = (document.getElementById('aboutLea')?.value || "").trim();
      const nils = (document.getElementById('aboutNils')?.value || "").trim();
      const from = GLOBAL_USER;
      if (!lea && !nils) return alert("Bitte schreibe etwas zu Lea oder Nils.");
      if (lea)  push(ref(db, 'about'), { who:'Lea',  text: lea,  from, ts: Date.now() });
      if (nils) push(ref(db, 'about'), { who:'Nils', text: nils, from, ts: Date.now() });
      const l = document.getElementById('aboutLea');  if (l) l.value = "";
      const n = document.getElementById('aboutNils'); if (n) n.value = "";
      logEvent('about_send');
    }
    aboutSendBtn.addEventListener('click', submitAbout);

    function renderAboutCard(id, v){
      const card = document.createElement('div');
      card.className = 'question';
      card.dataset.id = id;

      const header = document.createElement('div');
      header.innerHTML = `<strong>${v.who}</strong>${v.from ? ` ‚Äì <span class="muted">von ${v.from}</span>` : ''}`;

      const btnWrap = document.createElement('div');
      btnWrap.style.display = 'inline-flex';
      btnWrap.style.gap = '6px';
      btnWrap.style.marginLeft = '8px';

      const editBtn = document.createElement('button');
      editBtn.className = 'del';
      editBtn.textContent = 'Bearbeiten';
      editBtn.style.display = window.__isAdmin ? 'inline-block' : 'none';
      editBtn.addEventListener('click', async () => {
        if(!window.__isAdmin) return;
        const newWho = prompt('Wer? (Lea oder Nils)', v.who);
        if (!newWho) return;
        const newText = prompt('Neuer Text:', v.text);
        if (newText === null) return;
        await update(ref(db, 'about/' + id), { who: newWho, text: newText });
      });

      const delBtn = document.createElement('button');
      delBtn.className = 'del';
      delBtn.textContent = '‚úï';
      delBtn.style.display = window.__isAdmin ? 'inline-block' : 'none';
      delBtn.addEventListener('click', () => {
        if(!window.__isAdmin) return;
        if(confirm("Diesen Eintrag l√∂schen?")) remove(ref(db, 'about/' + id));
      });

      btnWrap.appendChild(editBtn);
      btnWrap.appendChild(delBtn);
      header.appendChild(btnWrap);

      const text = document.createElement('div');
      text.style.marginTop = '6px';
      text.textContent = v.text;

      card.appendChild(header);
      card.appendChild(text);
      return card;
    }

    onChildAdded(ref(db, 'about'), (snap) => {
      const id = snap.key;
      const v  = snap.val();
      const card = renderAboutCard(id, v);
      aboutList.appendChild(card);
      refreshAdminUI();
    });

    onChildChanged(ref(db, 'about'), (snap) => {
      const id = snap.key;
      const v = snap.val();
      const old = document.querySelector(`.question[data-id="${id}"]`);
      if (old) old.replaceWith(renderAboutCard(id, v));
      refreshAdminUI();
    });

    onChildRemoved(ref(db, 'about'), (snap) => {
      const id = snap.key;
      const el = document.querySelector(`.question[data-id="${id}"]`);
      if (el) el.remove();
    });

    /* ===== MUSIKWUNSCH ‚Äì 1 pro Stunde ===== */
    const songSendBtn = document.getElementById('songSend');
    const songHint = document.getElementById('songHint');
    const songList = document.getElementById('songList');

    songSendBtn.addEventListener('click', async () => {
      if(!GLOBAL_USER){ alert("Bitte zuerst deinen Namen eingeben."); return; }
      const title = (document.getElementById('songTitle')?.value || '').trim();
      const artist= (document.getElementById('songArtist')?.value || '').trim();
      const note  = (document.getElementById('songNote')?.value || '').trim();
      if(!title || !artist) return alert("Bitte Songtitel und K√ºnstler angeben.");

      const uname = GLOBAL_USER;
      const limitRef = ref(db, 'musicLimits/' + encodeURIComponent(uname));
      const snap = await get(limitRef);
      const now = Date.now();
      const hourMs = 60*60*1000;
      const last = snap.exists() ? Number(snap.val().lastTs||0) : 0;

      if (now - last < hourMs) {
        const mins = Math.ceil((hourMs - (now-last)) / 60000);
        songHint.textContent = `Bitte warte noch ${mins} Min., bevor du einen neuen Wunsch sendest.`;
        return;
      }

      push(ref(db, 'music'), { user: uname, title, artist, note, ts: now });
      await set(limitRef, { lastTs: now });

      document.getElementById('songTitle').value = '';
      document.getElementById('songArtist').value = '';
      document.getElementById('songNote').value = '';
      songHint.textContent = 'Danke! Dein Wunsch wurde gespeichert.';
      logEvent('music_send');
    });

    onChildAdded(ref(db, 'music'), (snap) => {
      const m = snap.val();
      const div = document.createElement('div');
      div.className = 'question';
      div.dataset.id = snap.key;
      const delBtn = document.createElement('button');
      delBtn.className = 'del';
      delBtn.textContent = '‚úï';
      delBtn.style.display = window.__isAdmin ? 'inline-block' : 'none';
      delBtn.addEventListener('click', () => {
        if(!window.__isAdmin) return;
        if(confirm("Diesen Musikwunsch l√∂schen?")) remove(ref(db, 'music/' + snap.key));
      });

      const header = document.createElement('div');
      header.innerHTML = `<strong>${m.title}</strong> ‚Äì ${m.artist} <span class="muted">(${m.user}, ${displayTime(m.ts)})</span>`;
      header.appendChild(delBtn);
      div.appendChild(header);

      if (m.note) {
        const note = document.createElement('div');
        note.className = 'muted';
        note.style.marginTop = '6px';
        note.textContent = `‚Äû${m.note}‚Äú`;
        div.appendChild(note);
      }

      songList.prepend(div);
      refreshAdminUI();
    });

    onChildRemoved(ref(db, 'music'), (snap) => {
      const el = document.querySelector(`[data-id="${snap.key}"]`);
      if(el) el.remove();
    });

    /* ===== ADMIN: einfache Statistiken (nur im Adminmodus sichtbar) ===== */
    const statsUsers = document.getElementById('statsUsers');
    const statsEvents = document.getElementById('statsEvents');
    const eventsList = document.getElementById('eventsList');
    const chartCanvas = document.getElementById('chartUsage');

    const userSet = new Set();
    onChildAdded(ref(db, 'users'), (snap) => {
      const uname = decodeURIComponent(snap.key);
      userSet.add(uname);
      if (window.__isAdmin && statsUsers) {
        statsUsers.textContent = `Einzigartige Nutzer: ${userSet.size}`;
      }
    });

    const todayHours = Array(24).fill(0);
    function redrawChart(){
      if (!window.__isAdmin || !chartCanvas) return;
      const ctx = chartCanvas.getContext('2d');
      const w = chartCanvas.width = chartCanvas.clientWidth;
      const h = chartCanvas.height = 220;
      ctx.clearRect(0,0,w,h);
      const max = Math.max(1, ...todayHours);
      const barW = w / 24 - 4;
      ctx.font = "12px system-ui";
      for(let i=0;i<24;i++){
        const x = i * (w/24) + 2;
        const val = todayHours[i];
        const bh = (val / max) * (h - 30);
        ctx.fillRect(x, h-20-bh, barW, bh);
        ctx.fillText(String(i), x+barW/2-4, h-5);
      }
    }
    function isToday(ts){
      const d = new Date(ts), n=new Date();
      return d.toDateString() === n.toDateString();
    }
    onChildAdded(ref(db, 'events'), (snap) => {
      const e = snap.val();
      if (window.__isAdmin) {
        const li = document.createElement('div');
        li.className = 'muted';
        li.textContent = `[${new Date(e.ts).toLocaleString()}] ${e.user}: ${e.action}`;
        eventsList?.prepend(li);
        if(isToday(e.ts)){
          const hr = new Date(e.ts).getHours();
          todayHours[hr] = (todayHours[hr]||0)+1;
          redrawChart();
        }
        const total = Number(statsEvents?.dataset.total||0) + 1;
        if (statsEvents){
          statsEvents.dataset.total = total;
          statsEvents.textContent = `Gesamt-Events: ${total}`;
        }
      }
    });

  </script>
</body>
</html>

