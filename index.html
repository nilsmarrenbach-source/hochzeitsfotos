<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hochzeit The Marrenbach's</title>

  <!-- Schriften -->
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#f8f6f4;
      --fg:#1a1a1a;
      --muted:#6a6a6a;
      --accent:#b74a3a; /* Rostrot */
      --accent-dark:#9d3f31;
      --mine:#fff2ef;    /* eigene Nachricht */
      --other:#ffffff;   /* fremde Nachricht */
      --border:#f0e4e1;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--fg);
      text-align:center;
    }

    /* Header */
    header {
      background:linear-gradient(180deg, var(--accent), var(--accent-dark));
      color:#fff;
      padding:28px 16px 22px;
      position:relative;
      overflow:hidden;
    }
    header h1 {
      margin:0;
      font-weight:400;
      font-size:36px;
      font-family:"Great Vibes", cursive;
    }

    /* Globaler Benutzername-Banner */
    #userBanner {
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    #userBanner .info { color:var(--muted); }
    #userBanner input { padding:8px 10px; border:1px solid #e9dcd8; border-radius:10px; font:inherit; }
    #userBanner .btn { padding:8px 12px; }

    /* Navigation */
    nav {
      display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:16px;
    }
    nav button {
      appearance:none; border:1px solid #e8d9d5; background:#fff; color:var(--accent);
      padding:10px 16px; border-radius:999px; cursor:pointer; font-weight:600;
      box-shadow:0 4px 14px rgba(183,74,58,.08);
    }
    nav button:hover { border-color:#e1c8c2; transform:translateY(-1px); }
    nav button[aria-current="page"] {
      background:var(--accent); color:#fff; border-color:var(--accent);
      box-shadow:0 6px 18px rgba(183,74,58,.25);
    }

    /* Layout */
    main { max-width:1000px; margin:0 auto; padding:10px 16px 40px; }
    .section {
      display:none; text-align:left; background:#fff; padding:22px; border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06); margin-top:8px;
      border:1px solid var(--border);
    }
    .section.active { display:block; }
    h2 {
      margin-top:0; text-align:center; font-family:"Playfair Display", serif; font-weight:600;
      color:var(--accent);
    }
    h3 { font-family:"Playfair Display", serif; }

    a.btn, .btn {
      display:inline-block; background:var(--accent); color:#fff; text-decoration:none;
      padding:10px 16px; border-radius:10px; margin:6px 6px 0; border:1px solid var(--accent-dark);
      box-shadow:0 6px 16px rgba(183,74,58,.25); cursor:pointer;
    }
    a.btn:hover, .btn:hover { filter:brightness(0.98); transform:translateY(-1px); }
    .grid2 { display:grid; grid-template-columns:1fr; gap:18px; }
    @media (min-width:700px){ .grid2 { grid-template-columns:1fr 1fr; } }
    iframe { width:100%; height:70vh; border:none; background:#f1f1f1; border-radius:12px; }

    .muted { color:var(--muted); font-size:.95rem; }
    .note { color:#9a8f8d; font-size:.9rem; text-align:center; }

    /* Startbild */
    img.hero { max-width:100%; border-radius:20px; box-shadow:0 10px 28px rgba(0,0,0,.15); }

    /* Quiz */
    .question { padding:16px 16px; border:1px solid var(--border); border-radius:12px; background:#fffdfc; }
    .answers label { display:block; margin:8px 0; padding:8px 10px; border:1px solid #f2e7e4; border-radius:10px; cursor:pointer; }
    .answers input { margin-right:8px; }
    #quiz-progress { font-family:"Playfair Display", serif; color:var(--muted); }
    ul#scoreboard { list-style:none; padding:0; margin:0; }
    ul#scoreboard li {
      padding:8px 10px; border-bottom:1px dashed #e5d6d2; display:flex; justify-content:space-between;
      font-family:"Playfair Display", serif;
    }

    /* Chat */
    #chatHeader { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    #messages { height:340px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:12px; background:#fffbfa; }
    .msg-wrap { display:flex; margin:6px 0; }
    .msg {
      padding:8px 10px; border-radius:10px; max-width:70%; word-wrap:break-word;
      border:1px solid #f2e7e4; background:var(--other); text-align:left;
    }
    .msg .meta { font-size:.8rem; color:#777; margin-bottom:4px; display:flex; align-items:center; gap:6px; }
    .msg .del { display:inline-block; margin-left:6px; background:none; border:1px solid #e1c8c2; border-radius:6px; padding:2px 6px; cursor:pointer; }
    .mine-wrap { justify-content:flex-end; }
    .mine { background:var(--mine); border-color:#f0d3cc; }
    .row { display:flex; gap:8px; align-items:center; }
    input[type="text"], textarea {
      width:100%; padding:10px 12px; border:1px solid #e9dcd8; border-radius:10px; font:inherit; background:#fffdfc;
    }

    /* PDF Zoom Toolbar */
    .pdfToolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 0}
    .pdfToolbar .btn{padding:6px 10px}
    .pdfViewport{position:relative;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#f1f1f1;height:70vh}
    .pdfViewport iframe{width:100%;height:100%;border:0;transform-origin:top left}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .stats{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:800px){.stats{grid-template-columns:1fr 1fr}}
    canvas{width:100%;height:220px;border:1px solid var(--border);border-radius:10px;background:#fff}
  </style>
</head>
<body>
  <header>
    <h1>Willkommen zur Hochzeit The Marrenbach's</h1>
  </header>

  <!-- Globaler Benutzername -->
  <div id="userBanner">
    <span class="info">Dein Benutzername f√ºr Chat, Quiz, ‚Äû√úber uns‚Äú & Musikwunsch:</span>
    <input type="text" id="globalName" placeholder="z. B. Theresa" />
    <button class="btn" id="saveName">Speichern</button>
    <span id="nameStatus" class="muted"></span>
  </div>

  <nav aria-label="Hauptnavigation">
    <button data-target="start" aria-current="page">üè† Startseite</button>
    <button data-target="fotos">üì∏ Fotos</button>
    <button data-target="speisekarte">üçΩÔ∏è Speisekarte</button>
    <button data-target="rede">üí¨ Hochzeitsrede</button>
    <button data-target="quiz">‚ùì Quiz</button>
    <button data-target="chat">üí¨ Chat</button>
    <button data-target="music">üéµ Musikwunsch</button>
    <button data-target="gaesteantworten">üìù √úber uns</button>
    <button data-target="admin">üõ†Ô∏è Admin</button>
  </nav>

  <main>
    <!-- Startseite -->
    <section id="start" class="section active">
      <h2>‚ù§Ô∏è Willkommen</h2>
      <p class="muted" style="text-align:center">Sch√∂n, dass ihr da seid ‚Äì feiert mit uns diesen besonderen Tag!</p>
      <div style="text-align:center; margin-top:20px;">
        <img src="start.jpg" alt="Brautpaar" class="hero" />
      </div>
    </section>

    <!-- Fotos -->
    <section id="fotos" class="section">
      <h2>üì∑ Fotos hochladen oder ansehen</h2>
      <p class="muted" style="text-align:center">W√§hlt eine Option:</p>
      <div class="grid2" style="text-align:center">
        <div>
          <h3>Hochladen</h3>
          <p>Teilt eure sch√∂nsten Momente mit uns!</p>
          <a class="btn" target="_blank" href="https://www.dropbox.com/request/yq0IJGtF4kC2J1Cfqyg3">üì• Fotos hochladen</a>
        </div>
        <div>
          <h3>Ansehen & Herunterladen</h3>
          <p>Alle Bilder der G√§ste an einem Ort.</p>
          <a class="btn" target="_blank" href="https://www.dropbox.com/scl/fo/2avn44dduw9frc86a2vuc/ADTyW_6937n1flsezIGobfQ?rlkey=si7t1g01cc8e8moy5oeahb6bo&st=8l1z0tg5&dl=0">üì§ Fotos ansehen</a>
        </div>
      </div>
    </section>

    <!-- Speisekarte -->
    <section id="speisekarte" class="section">
      <h2>üçΩÔ∏è Speisekarte</h2>
      <div class="pdfToolbar">
        <button class="btn" onclick="zoomPDF('menuFrame','out')">‚àí</button>
        <button class="btn" onclick="zoomPDF('menuFrame','reset')">100%</button>
        <button class="btn" onclick="zoomPDF('menuFrame','in')">+</button>
        <a class="btn" href="speisekarte.pdf" target="_blank">üîé Vollbild</a>
      </div>
      <div class="pdfViewport">
        <iframe id="menuFrame" src="speisekarte.pdf" title="Speisekarte"></iframe>
      </div>
      <div id="menuFallback" class="note" style="display:none;">Speisekarte nicht gefunden (speisekarte.pdf).</div>
    </section>

    <!-- Rede -->
    <section id="rede" class="section">
      <h2>üí¨ Hochzeitsrede</h2>
      <div class="pdfToolbar">
        <button class="btn" onclick="zoomPDF('speechFrame','out')">‚àí</button>
        <button class="btn" onclick="zoomPDF('speechFrame','reset')">100%</button>
        <button class="btn" onclick="zoomPDF('speechFrame','in')">+</button>
        <a class="btn" href="hochzeitsrede.pdf" target="_blank">üîé Vollbild</a>
      </div>
      <div class="pdfViewport">
        <iframe id="speechFrame" src="hochzeitsrede.pdf" title="Hochzeitsrede"></iframe>
      </div>
      <div id="speechFallback" class="note" style="display:none;">Hochzeitsrede nicht gefunden (hochzeitsrede.pdf).</div>
    </section>

    <!-- Quiz (Einzelfragen) -->
    <section id="quiz" class="section">
      <h2>‚ùì Hochzeitsquiz</h2>
      <div id="quiz-login">
        <p>Dein Benutzername wird automatisch genutzt (oben setzen).</p>
        <button class="btn" id="quizStart">Quiz starten</button>
      </div>
      <div id="quiz-run" style="display:none">
        <div style="text-align:center; margin-bottom:8px;" class="muted">
          <span id="quiz-progress">Frage 1/10</span>
        </div>
        <div id="quiz-question" class="question"></div>
        <div id="quiz-answers" class="answers" style="margin-top:8px;"></div>
        <div style="text-align:center; margin-top:14px;">
          <button class="btn" id="quizNext" disabled>Weiter</button>
        </div>
      </div>
      <div id="result" style="display:none; text-align:center; font-weight:600; margin-top:14px"></div>
      <div class="scoreboard" style="margin-top:18px;">
        <h3 style="text-align:center">üèÜ Rangliste</h3>
        <ul id="scoreboard"></ul>
      </div>
    </section>

    <!-- Chat -->
    <section id="chat" class="section">
      <h2>üí¨ Hochzeitschat</h2>
      <div id="chatHeader">
        <div class="muted" id="chatStatus"></div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="muted" id="chatUserBadge"></div>
          <button class="btn" id="adminLogin" style="padding:6px 10px;">Admin</button>
        </div>
      </div>

      <div id="chatBox">
        <div id="messages"></div>
        <div class="row" style="margin-top:10px;">
          <input type="text" id="messageInput" placeholder="Deine Nachricht" />
          <button class="btn" id="chatSend">Senden</button>
        </div>
      </div>
    </section>

    <!-- Musikwunsch -->
    <section id="music" class="section">
      <h2>üéµ Musikwunsch</h2>
      <p class="muted" style="text-align:center">Jede*r darf <strong>maximal einen Wunsch pro Stunde</strong> abgeben.</p>
      <div class="grid2">
        <div class="card">
          <div class="row">
            <input type="text" id="songTitle" placeholder="Songtitel" />
          </div>
          <div class="row" style="margin-top:8px;">
            <input type="text" id="songArtist" placeholder="K√ºnstler*in" />
          </div>
          <div class="row" style="margin-top:8px;">
            <input type="text" id="songNote" placeholder="Widmung/Kommentar (optional)" />
          </div>
          <div style="text-align:center; margin-top:10px;">
            <button class="btn" id="songSend">Wunsch senden</button>
            <div id="songHint" class="muted" style="margin-top:6px;"></div>
          </div>
        </div>
        <div class="card">
          <h3 style="text-align:center;margin:0 0 8px;">Letzte W√ºnsche</h3>
          <div id="songList"></div>
        </div>
      </div>
    </section>

    <!-- √úber uns -->
    <section id="gaesteantworten" class="section">
      <h2>üìù √úber uns</h2>
      <p class="muted">Schreib eine kurze Zeile ‚Äì was macht <strong>Lea</strong> und was macht <strong>Nils</strong> aus?</p>
      <div class="grid2">
        <div>
          <h3>Zu Lea</h3>
          <textarea id="aboutLea" rows="4" placeholder="Dein Satz zu Lea..."></textarea>
        </div>
        <div>
          <h3>Zu Nils</h3>
          <textarea id="aboutNils" rows="4" placeholder="Dein Satz zu Nils..."></textarea>
        </div>
      </div>
      <div style="text-align:center; margin-top:10px;">
        <button class="btn" id="aboutSend">Absenden</button>
      </div>
      <div style="margin-top:16px;">
        <h3 style="text-align:center">Eure Antworten (live)</h3>
        <div id="aboutList" class="grid2"></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="section">
      <h2>üõ†Ô∏è Admin-Dashboard</h2>
      <p class="muted" id="adminState">Nicht im Adminmodus. Klicke im Chat oben rechts auf ‚ÄûAdmin‚Äú und gib den Code ein.</p>
      <div class="stats">
        <div class="card">
          <h3 style="margin-top:0;">Nutzer & Aktivit√§t</h3>
          <div id="statsUsers" class="muted">‚Äì</div>
          <div id="statsEvents" class="muted">‚Äì</div>
        </div>
        <div class="card">
          <h3 style="margin-top:0;">Nutzung nach Stunde (heute)</h3>
          <canvas id="chartUsage"></canvas>
        </div>
      </div>
      <div class="card" style="margin-top:12px;">
        <h3 style="margin-top:0;">Letzte Aktionen</h3>
        <div id="eventsList"></div>
      </div>
    </section>
  </main>

  <!-- PDF-Zoom -->
  <script>
    const __pdfScale = {};
    function zoomPDF(frameId, action){
      const frame = document.getElementById(frameId);
      if(!frame) return;
      const cur = __pdfScale[frameId] ?? 1;
      let s = cur;
      if(action==='in')  s = Math.min(3,  (cur + 0.2));
      if(action==='out') s = Math.max(0.5,(cur - 0.2));
      if(action==='reset') s = 1;
      __pdfScale[frameId] = s;
      frame.style.transform = `scale(${s})`;
      frame.style.width = `${100/s}%`;
      frame.style.height = '100%';
    }
  </script>

  <!-- Navigation + PDF-Fallbacks -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const navButtons = document.querySelectorAll('nav button');
      function activate(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        navButtons.forEach(b => b.removeAttribute('aria-current'));
        if (btn) btn.setAttribute('aria-current','page');
      }
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => activate(btn.dataset.target, btn));
      });

      // PDF-Fallback-Hinweise
      const mf = document.getElementById('menuFrame');
      const sf = document.getElementById('speechFrame');
      setTimeout(() => {
        if (mf && mf.contentDocument === null) document.getElementById('menuFallback').style.display='block';
        if (sf && sf.contentDocument === null) document.getElementById('speechFallback').style.display='block';
      }, 1200);
    });
  </script>

  <!-- App-Logik & Firebase (modular) -->
  <script type="module">
    /* Firebase ES Modules ‚Äì stabile 9.23.0 */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, onChildRemoved, remove,
      get, set, update, child
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /* Firebase-Konfiguration */
    const firebaseConfig = {
      apiKey: "AIzaSyDEYeCmTkVGf4pTLCS-s3fV9jo1ivVPMj8",
      authDomain: "hochzeitschat.firebaseapp.com",
      databaseURL: "https://hochzeitschat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hochzeitschat",
      storageBucket: "hochzeitschat.appspot.com",
      messagingSenderId: "180005609648",
      appId: "1:180005609648:web:f8c8cd278a1e3830501b75"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ===== Globaler Benutzername ===== */
    const nameInput = document.getElementById('globalName');
    const saveNameBtn = document.getElementById('saveName');
    const nameStatus = document.getElementById('nameStatus');

    const ADMIN_CODE = "Marrenbach24!";
    let isAdmin = false;

    function getUser(){
      return (localStorage.getItem('appUserName')||"").trim();
    }
    function setUser(n){
      localStorage.setItem('appUserName', n);
      nameStatus.textContent = `üîí Eingeloggt als: ${n}`;
      // als ‚Äûuser‚Äú in DB registrieren / aktualisieren
      const uref = ref(db, 'users/' + encodeURIComponent(n));
      update(uref, { lastSeen: Date.now(), createdAt: Date.now() }).catch(()=>{});
      logEvent('login');
    }

    // init Banner
    const existing = getUser();
    if(existing){
      nameInput.value = existing;
      nameStatus.textContent = `üîí Eingeloggt als: ${existing}`;
    }

    saveNameBtn.addEventListener('click', () => {
      const n = (nameInput.value||"").trim();
      if(!n) return alert("Bitte gib einen Namen ein.");
      if(getUser()){ return alert("Benutzername ist bereits gesetzt (f√ºr diese Sitzung)."); }
      setUser(n);
    });

    // kleine Helper
    function requireUser(){
      const u = getUser();
      if(!u){ alert("Bitte oben deinen Benutzernamen setzen."); }
      return !!u;
    }
    function displayTime(ts){
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    /* ===== Events / Stats logging ===== */
    function logEvent(action, extra = {}){
      const u = getUser() || 'Gast';
      push(ref(db, 'events'), { user: u, action, ts: Date.now(), ...extra });
    }
    // Beim Laden: ‚Äûvisit‚Äú
    logEvent('visit');

    /* ===== QUIZ ===== */
    const questions = [
      { q:'Welches Haushaltsger√§t wird von Lea t√§glich genutzt und treibt Nils in den Wahnsinn?', a:['Trockner','Staubsauger','Wasserkocher'], correct:'Staubsauger' },
      { q:'Wann sind Lea und Nils zusammengekommen?', a:['08.03.2017','18.03.2018','28.03.2017'], correct:'28.03.2017' },
      { q:'Wer von deren Freunden war beim ersten Date anwesend?', a:['Theresa','Lea-Stutzinger','Markus'], correct:'Theresa' },
      { q:'Welche Handgeste hat Lea ihrem Schwiegervater beim ersten Kennenlernen zur Begr√º√üung gezeigt?', a:['Peacezeichen','Gewinkt','High 5'], correct:'Peacezeichen' },
      { q:'Was war Nils schlimmstes Verbrechen bei seinen Schwiegereltern?', a:['nichtabgesp√ºlt nach langer Toilettensitzung','aus dem Dachfenster √ºbergeben','Ollis Schraubschl√ºssel geliehen und nie wiedergegeben'], correct:'aus dem Dachfenster √ºbergeben' },
      { q:'Welche Krankheit schreibt Lea Nils zu?', a:['Autismus','Achs','Zwangsst√∂rung'], correct:'Autismus' },
      { q:'Zu was wird Lea wenn sie schlecht gelaunt ist?', a:['dem unglaublichen Hulk','Giftzwerg','Fruchtzwerg'], correct:'Giftzwerg' },
      { q:'Wie lautet Nils legend√§rer durch seine Mutter vergebener Spitzname?', a:['b√ºbchen','mamab√§rchen','p√ºppelmann'], correct:'p√ºppelmann' },
      { q:'Was ist Nils und Leas Einrichtungssteal?', a:['Antik','modern','Eklektizismus'], correct:'Eklektizismus' },
      { q:'Wer hat zuhause die Hosen an?', a:['Lea','Nils','Beide'], correct:'Beide' },
    ];

    const quizStartBtn = document.getElementById('quizStart');
    const quizLogin    = document.getElementById('quiz-login');
    const quizRun      = document.getElementById('quiz-run');
    const quizQ        = document.getElementById('quiz-question');
    const quizA        = document.getElementById('quiz-answers');
    const quizNextBtn  = document.getElementById('quizNext');
    const quizProgress = document.getElementById('quiz-progress');
    const resultEl     = document.getElementById('result');
    const scoreboardEl = document.getElementById('scoreboard');

    let quizUser = "";
    let currentIndex = 0;
    const givenAnswers = Array(questions.length).fill(null);

    function renderQuestion() {
      const q = questions[currentIndex];
      quizProgress.textContent = `Frage ${currentIndex + 1}/${questions.length}`;
      quizQ.innerHTML = `<p><strong>${currentIndex + 1}.</strong> ${q.q}</p>`;
      const currentGiven = givenAnswers[currentIndex];

      quizA.innerHTML = q.a.map(ans => {
        const checked = currentGiven === ans ? "checked" : "";
        return `<label><input type="radio" name="q" value="${ans}" ${checked}> ${ans}</label>`;
      }).join("");

      quizNextBtn.disabled = currentGiven === null;

      quizA.querySelectorAll('input[name="q"]').forEach(r => {
        r.addEventListener('change', () => {
          givenAnswers[currentIndex] = r.value;
          quizNextBtn.disabled = false;
        });
      });

      quizNextBtn.textContent = (currentIndex === questions.length - 1) ? "Abschicken" : "Weiter";
    }

    function startQuiz() {
      if(!requireUser()) return;
      quizUser = getUser();
      currentIndex = 0;
      givenAnswers.fill(null);

      quizLogin.style.display = 'none';
      quizRun.style.display   = 'block';
      resultEl.style.display  = 'none';
      renderQuestion();
      logEvent('quiz_start');
    }

    quizStartBtn.addEventListener('click', startQuiz);

    quizNextBtn.addEventListener('click', () => {
      if (currentIndex === questions.length - 1) {
        let score = 0;
        questions.forEach((q, i) => { if (givenAnswers[i] === q.correct) score++; });

        push(ref(db, 'scores'), { name: quizUser, score, total: questions.length, ts: Date.now() });
        quizRun.style.display  = 'none';
        resultEl.style.display = 'block';
        resultEl.textContent   = `${quizUser}, du hast ${score} von ${questions.length} Punkten erreicht!`;
        logEvent('quiz_finish', { score });
        return;
      }
      currentIndex++;
      renderQuestion();
    });

    const scores = [];
    onChildAdded(ref(db, 'scores'), (snap) => {
      const v = snap.val();
      scores.push(v);
      const sorted = [...scores].sort((a,b) => b.score - a.score || a.ts - b.ts);
      scoreboardEl.innerHTML = sorted
        .map((s,i)=>`<li><span>${i+1}. ${s.name}</span><strong>${s.score}/${s.total}</strong></li>`)
        .join('');
    });

    /* ===== CHAT mit Admin-L√∂schen ===== */
    const chatSendBtn = document.getElementById('chatSend');
    const messagesEl   = document.getElementById('messages');
    const chatStatus   = document.getElementById('chatStatus');
    const chatUserBadge= document.getElementById('chatUserBadge');
    const adminLoginBtn= document.getElementById('adminLogin');

    if(getUser()){
      chatUserBadge.textContent = `üîí Eingeloggt als: ${getUser()}`;
      chatStatus.textContent = "Verbunden";
    } else {
      chatStatus.textContent = "Bitte oben Benutzernamen setzen.";
    }

    adminLoginBtn?.addEventListener('click', () => {
      const code = prompt("Admin-Code eingeben:");
      if (code === ADMIN_CODE) {
        isAdmin = true;
        alert("Admin-Modus aktiv.");
        document.getElementById('adminState').textContent = "Adminmodus aktiv.";
        refreshAdminUI();
      } else if (code !== null) {
        alert("Falscher Code.");
      }
    });

    function refreshAdminUI() {
      document.querySelectorAll('.msg .del').forEach(btn => {
        btn.style.display = isAdmin ? 'inline-block' : 'none';
      });
    }

    function sendMessage(){
      if(!requireUser()) return;
      const inp = document.getElementById('messageInput');
      const msg = (inp?.value || "").trim();
      if (!msg) return;
      push(ref(db, 'messages'), { name: getUser(), message: msg, ts: Date.now() });
      inp.value = "";
      logEvent('chat_send');
    }
    chatSendBtn.addEventListener('click', sendMessage);

    onChildAdded(ref(db, 'messages'), (snap) => {
      const id = snap.key;
      const m  = snap.val();
      const mine = (getUser() && m.name === getUser());

      const wrap = document.createElement('div');
      wrap.className = mine ? 'msg-wrap mine-wrap' : 'msg-wrap';
      wrap.dataset.id = id;

      const bubble = document.createElement('div');
      bubble.className = mine ? 'msg mine' : 'msg';
      const time = displayTime(m.ts);

      const del = document.createElement('button');
      del.className = 'del';
      del.textContent = '‚úï';
      del.style.display = isAdmin ? 'inline-block' : 'none';
      del.addEventListener('click', () => {
        if (!isAdmin) return;
        if (confirm("Diese Nachricht wirklich l√∂schen?")) {
          remove(ref(db, 'messages/' + id));
        }
      });

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `[${time}] <strong>${m.name}</strong>`;
      meta.appendChild(del);

      const txt = document.createElement('div');
      txt.textContent = m.message;

      bubble.appendChild(meta);
      bubble.appendChild(txt);
      wrap.appendChild(bubble);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    onChildRemoved(ref(db, 'messages'), (snap) => {
      const id = snap.key;
      const el = document.querySelector(`.msg-wrap[data-id="${id}"]`);
      if (el) el.remove();
    });

    /* ===== √úBER UNS ‚Äì Eintr√§ge + Admin-L√∂schen ===== */
    const aboutSendBtn = document.getElementById('aboutSend');
    const aboutList    = document.getElementById('aboutList');

    function submitAbout(){
      if(!requireUser()) return;
      const lea  = (document.getElementById('aboutLea')?.value || "").trim();
      const nils = (document.getElementById('aboutNils')?.value || "").trim();
      const from = getUser();
      if (!lea && !nils) return alert("Bitte schreibe etwas zu Lea oder Nils.");
      if (lea)  push(ref(db, 'about'), { who:'Lea',  text: lea,  from, ts: Date.now() });
      if (nils) push(ref(db, 'about'), { who:'Nils', text: nils, from, ts: Date.now() });
      const l = document.getElementById('aboutLea');  if (l) l.value = "";
      const n = document.getElementById('aboutNils'); if (n) n.value = "";
      logEvent('about_send');
    }
    aboutSendBtn.addEventListener('click', submitAbout);

    onChildAdded(ref(db, 'about'), (snap) => {
      const id = snap.key;
      const v  = snap.val();
      const card = document.createElement('div');
      card.className = 'question';
      card.dataset.id = id;
      const from = v.from ? ` ‚Äì <span class="muted">von ${v.from}</span>` : '';
      const del = isAdmin ? `<button class="del" data-id="${id}">‚úï</button>` : '';
      card.innerHTML = `<div><strong>${v.who}</strong>${from} ${del}</div><div style="margin-top:6px;">${v.text}</div>`;
      card.querySelector('.del')?.addEventListener('click', () => {
        if(!isAdmin) return;
        if(confirm("Diesen Eintrag l√∂schen?")) remove(ref(db, 'about/' + id));
      });
      aboutList.appendChild(card);
      refreshAdminUI();
    });

    onChildRemoved(ref(db, 'about'), (snap) => {
      const id = snap.key;
      const el = document.querySelector(`.question[data-id="${id}"]`);
      if (el) el.remove();
    });

    /* ===== MUSIKWUNSCH ‚Äì 1 pro Stunde ===== */
    const songSendBtn = document.getElementById('songSend');
    const songHint = document.getElementById('songHint');
    const songList = document.getElementById('songList');

    songSendBtn.addEventListener('click', async () => {
      if(!requireUser()) return;
      const title = (document.getElementById('songTitle')?.value || '').trim();
      const artist= (document.getElementById('songArtist')?.value || '').trim();
      const note  = (document.getElementById('songNote')?.value || '').trim();
      if(!title || !artist) return alert("Bitte Songtitel und K√ºnstler*in angeben.");

      const uname = getUser();
      const limitRef = ref(db, 'musicLimits/' + encodeURIComponent(uname));
      const snap = await get(limitRef);
      const now = Date.now();
      const hourMs = 60*60*1000;
      const last = snap.exists() ? Number(snap.val().lastTs||0) : 0;

      if (now - last < hourMs) {
        const mins = Math.ceil((hourMs - (now-last)) / 60000);
        songHint.textContent = `Bitte warte noch ${mins} Min., bevor du einen neuen Wunsch sendest.`;
        return;
      }

      // Wunsch speichern
      push(ref(db, 'music'), { user: uname, title, artist, note, ts: now });
      // Limit setzen
      await set(limitRef, { lastTs: now });

      // Felder leeren
      document.getElementById('songTitle').value = '';
      document.getElementById('songArtist').value = '';
      document.getElementById('songNote').value = '';
      songHint.textContent = 'Danke! Dein Wunsch wurde gespeichert.';
      logEvent('music_send');
    });

    onChildAdded(ref(db, 'music'), (snap) => {
      const m = snap.val();
      const div = document.createElement('div');
      div.className = 'question';
      div.dataset.id = snap.key;
      const delBtn = isAdmin ? `<button class="del" data-id="${snap.key}">‚úï</button>` : '';
      div.innerHTML = `<strong>${m.title}</strong> ‚Äì ${m.artist} <span class="muted">(${m.user}, ${displayTime(m.ts)})</span> ${delBtn}
                       ${m.note ? `<div class="muted" style="margin-top:6px;">‚Äû${m.note}‚Äú</div>` : ''}`;
      div.querySelector('.del')?.addEventListener('click', () => {
        if(!isAdmin) return;
        if(confirm("Diesen Musikwunsch l√∂schen?")) remove(ref(db, 'music/' + snap.key));
      });
      songList.prepend(div);
      refreshAdminUI();
    });
    onChildRemoved(ref(db, 'music'), (snap) => {
      const el = document.querySelector(`[data-id="${snap.key}"]`);
      if(el) el.remove();
    });

    /* ===== ADMIN: einfache Statistiken ===== */
    const statsUsers = document.getElementById('statsUsers');
    const statsEvents = document.getElementById('statsEvents');
    const eventsList = document.getElementById('eventsList');
    const chartCanvas = document.getElementById('chartUsage');

    // Nutzer z√§hlen
    const userSet = new Set();
    onChildAdded(ref(db, 'users'), (snap) => {
      const uname = decodeURIComponent(snap.key);
      userSet.add(uname);
      statsUsers.textContent = `Einzigartige Nutzer*innen: ${userSet.size}`;
    });

    // Events anzeigen + heutige Nutzung nach Stunden
    const todayHours = Array(24).fill(0);
    function redrawChart(){
      const ctx = chartCanvas.getContext('2d');
      const w = chartCanvas.width = chartCanvas.clientWidth;
      const h = chartCanvas.height = 220;
      ctx.clearRect(0,0,w,h);
      const max = Math.max(1, ...todayHours);
      const barW = w / 24 - 4;
      for(let i=0;i<24;i++){
        const x = i * (w/24) + 2;
        const val = todayHours[i];
        const bh = (val / max) * (h - 30);
        ctx.fillRect(x, h-20-bh, barW, bh);
        ctx.fillText(String(i), x+barW/2-4, h-5);
      }
    }
    function isToday(ts){
      const d = new Date(ts), n=new Date();
      return d.toDateString() === n.toDateString();
    }
    onChildAdded(ref(db, 'events'), (snap) => {
      const e = snap.val();
      // Liste
      const li = document.createElement('div');
      li.className = 'muted';
      li.textContent = `[${new Date(e.ts).toLocaleString()}] ${e.user}: ${e.action}`;
      eventsList.prepend(li);
      // Stunde z√§hlen (nur heute)
      if(isToday(e.ts)){
        const hr = new Date(e.ts).getHours();
        todayHours[hr] = (todayHours[hr]||0)+1;
        redrawChart();
      }
      // Gesamt
      const total = Number(statsEvents.dataset.total||0) + 1;
      statsEvents.dataset.total = total;
      statsEvents.textContent = `Gesamt-Events: ${total}`;
    });

    // Wenn Name gesetzt/aktiv ‚áí user in DB registrieren
    if(getUser()){
      const uref = ref(db, 'users/' + encodeURIComponent(getUser()));
      update(uref, { lastSeen: Date.now(), createdAt: Date.now() }).catch(()=>{});
    }
  </script>
</body>
</html>



